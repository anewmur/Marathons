# Спецификация главы "Возрастная модель на нормированной шкале"

## I. ПРАВИЛА ЛЕКСИКИ И ТЕРМИНОЛОГИИ

### 1. Режимы работы
- **LOY** (leave-one-year-out) — режим валидации, обучение без года $j^\ast$
- **production** — рабочий режим для новых прогнозов
- **НЕ использовать:** "эксплуатационный режим", "мир данных/расчёта"

### 2. Шкалы и переменные
- $T$ — время финиша (исходная шкала)
- $Y = \ln T$ — логарифмическая шкала
- $Z = \ln T - \ln R^{\text{use}}$ — нормированная логарифмическая шкала (БЕЗ звёздочки $Z^\ast$)
- $z_r$ — наблюдаемое значение на шкале $Z$ (строчная буква для реализаций)

### 3. Индексация
- $r$ — индекс наблюдения (используется для индексации данных)
- $i$ — индекс участника (используется только в общих формулах)
- $g$ — пол ($0$ для мужчин, $1$ для женщин)
- $c$ — трасса (course)
- $j$ — календарный год
- $a$ — возраст
- Целевая конфигурация: $(c^\ast, g, j^\ast, a_{\text{new}})$

### 4. Обозначения эталонов
- $\hat R^{\text{use}}$ — эталон для нормировки (ВСЕГДА `\text{use}`, НЕ `\mathrm{use}`)
- $\tau^{2,\text{use}}$ — процедурная дисперсия ошибки эталона
- $(\hat R^{\text{use}}, \tau^{2,\text{use}})$ — согласованная пара (строятся на одних данных)

### 5. Параметры модели
- $\hat\theta_g = (\hat\mu_g, \hat\gamma_g, \hat\beta_g)^\top$ — вектор параметров
- $\hat\sigma_g^2$ — рабочий масштаб (дисперсия)
- $s_{\text{pred}}$ — прогностический масштаб (стандартное отклонение)
- $\nu_g$ — степени свободы
- $\kappa_g$ — калибровочный коэффициент

### 6. Матрицы и векторы
- $W_g$ — матрица объясняющих переменных (design matrix)
- $c_\ast$ — вектор регрессоров в точке прогноза
- $R_g = R^{\text{qr}}_g(\hat\lambda_g)$ — верхнетреугольная матрица из QR
- $b_{g,k}(x)$ — центрированные базисные функции (БЕЗ тильды $\widetilde{b}$)

### 7. Терминология
- "рабочее прогностическое распределение" (НЕ "рабочая модель шума")
- "процедурная дисперсия" (для $\tau^{2,\text{use}}$)
- "калибровочный коэффициент" (для $\kappa_g$)
- "винзоризация" (НЕ "винсоризация")
- "режим" (НЕ "мир данных/расчёта")

### 8. Численные пороги (константы в MVP)
- $\varepsilon_R = 10^{-12}$ — порог устойчивости QR
- $\varepsilon_\Lambda = 10^{-10} \max(1, \max_i \Lambda_{g,ii})$ — порог регуляризации
- $K_z = 3$ — коэффициент MAD-винзоризации
- $\nu_{\min} = 3$ — минимальные степени свободы
- $K^{\text{(inner)}}_{\min} = 3$ — минимальное число внутренних узлов
- $N_{\min} = 25\,000$, $N_{\max} = 400\,000$ — границы Монте-Карло
- $\Delta_Y = 0.002$ — порог сходимости квантилей

---

## II. ПРАВИЛА МАТЕМАТИЧЕСКОГО ПОДХОДА

### 1. Иерархия шкал
$$
T \xrightarrow{\ln} Y = \ln T \xrightarrow{-\ln R^{\text{use}}} Z = \ln T - \ln R^{\text{use}}
$$
- Прогноз строится на шкале $Z$ (возрастная модель)
- Переход к $Y$ и $T$ — только через Монте-Карло (НЕ аналитически)

### 2. Разложение модели
$$
Z_{i,j,c,g} = \mu_g + \gamma_g x + h_g(x) + \varepsilon_{i,j,c,g}
$$
где:
- $x = (a - a^o)/A$ — нормированный возраст ($a^o=35$, $A=10$)
- $h_g(x)$ — нелинейная возрастная компонента (сплайн с центрированием)
- $\mu_g + \gamma_g x$ — линейный тренд
- Условия центрирования: $h_g(0)=0$, $h'_g(0)=0$ (в точке $a^o=35$)

### 3. Базис и параметризация
- Исходный базис: $B_{g,k}(a)$, $k=1,\dots,K_g$ (кубические B-сплайны, степень $d=3$)
- Центрированный базис: $b_{g,k}(x) = \sum_{\ell=1}^{K_g} C_{g,\ell k} B_{g,\ell}(a(x))$, $k=1,\dots,K_g-2$
- Матрица перехода $C_g$ (размер $K_g \times (K_g-2)$): из QR-разложения ограничений
- Связь: $\alpha_g = C_g \beta_g$

### 4. Разделение компонент неопределённости
На шкале $Z$:
$$
Z_{\text{new}} = \hat m_\ast + \kappa_g s_{\text{pred}} \xi, \quad \xi \sim t_{\nu_g}
$$

На шкале $Y$:
$$
Y_{\text{new}} = \ln \hat R^{\text{use}} + Z_{\text{new}} + \delta, \quad \delta \sim N(0, \tau^{2,\text{use}})
$$

**Ключевой принцип:** Независимость $\xi$ и $\delta$ (рабочее допущение)

### 5. Оценка параметров: REML с регуляризацией
- Штрафуемая задача: $\min \{\|z_g - W_g\theta_g\|^2 + \lambda \|L_g\theta_g\|^2\}$
- Матрица штрафа $K^{\text{full}}_g$ (блочно-диагональная: нули для $\mu_g, \gamma_g$; блок $\tilde{K}^{\beta}_g$ для $\beta_g$)
- Спектральная регуляризация: $\tilde{K}^{\beta}_g = U_g \tilde{\Lambda}_g U_g^\top$ с занулением $|\Lambda_{g,ii}| < \varepsilon_\Lambda$
- REML-критерий для выбора $\hat\lambda_g$:
$$
\text{REML}_g(\lambda) = (n_g - \text{edf}_g(\lambda)) \log \hat\sigma^2_g(\lambda) + 2 \sum_{k=1}^{p_g} \log |R^{\text{qr}}_{g,kk}(\lambda)|
$$

### 6. Корректировка масштаба
$$
\hat\sigma_g^2 = \max(0, \hat\sigma_g^{2,\text{REML}} - \bar{\tau}^2_g)
$$
где $\bar{\tau}^2_g = \frac{1}{n_g} \sum_{r=1}^{n_g} \tau^{2,\text{use}}_r$ — среднее по наблюдениям (вариант A).

**Важно:** Это эвристическая корректировка, НЕ строгое разложение дисперсии.

### 7. Калибровка покрытия
- Перебор по сетке $\mathcal{K} = \{0.50, 0.55, \dots, 3.00\}$ с шагом $0.05$
- Эмпирическое покрытие центрального $90\%$-интервала:
$$
\widehat{\text{cov}}_g(\kappa) = \frac{1}{|\mathcal{I}_g^{\text{LOY}}|} \sum_{r \in \mathcal{I}_g^{\text{LOY}}} \mathbf{1}\{\widehat{q}_{0.05,r}(\kappa) \le Y_r^{\text{obs}} \le \widehat{q}_{0.95,r}(\kappa)\}
$$
- Минимизация $|\widehat{\text{cov}}_g(\kappa) - 0.90|$
- **Ключевой принцип:** Калибровка ТОЛЬКО по эмпирическому покрытию MC-интервалов (НЕ аналитические формулы)

### 8. Монте-Карло протокол
- Детерминированный seed: BLAKE2b от $(c^\ast, g, j^\ast, a_\mu, \text{mode})$ с SALT
- Канонизация возраста: $a_\mu = \lfloor 10^6 a_{\text{new}} + 0.5 \rfloor$
- Адаптивный выбор $N$: начиная с $N_{\min}=25\,000$, удвоение до $N_{\max}=400\,000$
- Критерий сходимости: $\max_{p \in \{0.05, 0.50, 0.95\}} |\widehat{q}_p^{(N')}(Y) - \widehat{q}_p^{(N)}(Y)| \le 0.002$
- Квантили: type 7 (R), т.е. `numpy.quantile(..., method='linear')`

### 9. Условия доступности прогноза
**Структурные:**
- $n_{c,g}(J') \ge n_{\min}$ (доступность эталона)
- $|S_{c,g}(J')| \ge m_{\min}$ (размер top-набора)
- $K^{\text{(inner)}}_g \ge 3$ (узлы сплайна)
- $t_{g,0} \le a_{\text{new}} \le t_{g,m_g}$ (возраст в пределах узлов)

**Численные:**
- $|R_{g,kk}| \ge \varepsilon_R$ для всех $k$ (устойчивость QR)
- $1 + c_\ast^\top w > 0$ (положительность прогностической дисперсии)
- $\nu_g > 3$ (степени свободы)
- Сходимость MC при $N \le N_{\max}$

---

## III. СПЕЦИФИКАЦИЯ МОДЕЛИ "ВОЗРАСТНЫЕ ПОПРАВКИ"

### A. Описание модели

**Цель:** Добавить к трассовым эталонам возрастную поправку, описывающую среднее отклонение от эталона в зависимости от возраста внутри пола.

**Модель на шкале $Z$:**
$$
z_r = \mu_g + \gamma_g x_r + \sum_{k=1}^{K_g-2} \beta_{g,k} b_{g,k}(x_r) + \varepsilon_r, \quad \varepsilon_r \sim N(0, \sigma_g^2)
$$
где:
- $r$ — наблюдение (участник $i$, год $j$, трасса $c$, пол $g$)
- $z_r = \ln T_r - \ln R^{\text{use}}_r$ — нормированное значение
- $x_r = (a_r - 35)/10$ — нормированный возраст
- $b_{g,k}(x_r)$ — центрированные B-сплайновые базисные функции
- Условия центрирования: $h_g(0)=0$, $h'_g(0)=0$ в точке $x=0$ (возраст $a=35$)

**Компактная запись:**
$$
z_g = W_g \theta_g + \varepsilon_g, \quad \varepsilon_g \sim N(0, \sigma_g^2 I_{n_g})
$$
где $\theta_g = (\mu_g, \gamma_g, \beta_g)^\top \in \mathbb{R}^{p_g}$, $p_g = K_g = m_g + 3$.

### B. Входные параметры (из предыдущих глав)

**Из главы "Эталоны":**
- $\hat R^{\text{use}}_{c,g}(J')$ — эталон для пары $(c,g)$ по годам $J'$
- $\tau^{2,\text{use}}_{c,g}(J')$ — процедурная дисперсия эталона
- $S_{c,g}(J')$ — top-набор (5% самых быстрых)
- Протокол: top-отбор с $p_{\text{top}}=0.05$, медиана, бутстрэп ($B=1000$ реплик)

**Режимы:**
- LOY: $J' = J \setminus \{j^\ast\}$
- Production (год известен): $J' = J \setminus \{j^\ast\}$ (эталон), $J$ (возрастная модель)
- Production (год новый): $J' = J$

**Исходные данные:**
- $\{(T_r, c_r, g_r, j_r, a_r)\}_{r=1}^N$ — завершённые финиши после очистки
- Уникализация: одна запись на тройку (участник, трасса, год)

### C. Подбираемые параметры (оцениваются в этой главе)

**Для каждого пола $g$ и режима (LOY/$j^\ast$ или production):**

1. **Узлы сплайна $\{t_{g,i}\}_{i=0}^{m_g}$:**
   - Метод: квантили по возрастам обучающей выборки
   - Уровни: $\{0.10, 0.20, \dots, 0.90\}$ (9 квантилей → 7 внутренних узлов)
   - Слияние близких узлов: $\Delta_{\min} = 1$ год
   - Условие: $K^{\text{(inner)}}_g \ge 3$ после слияния

2. **Параметр сглаживания $\hat\lambda_g$:**
   - Метод: минимизация REML-критерия
   - Границы: $\lambda \in [10^{-8}, 10^8]$ (поиск по $\eta = \log_{10}\lambda \in [-8, 8]$)
   - Оптимизация: `scipy.optimize.minimize_scalar` (метод Brent)
   - Фильтры: $\nu_g(\lambda) > 3$, $|R^{\text{qr}}_{g,kk}(\lambda)| \ge \varepsilon_R$

3. **Вектор параметров $\hat\theta_g = (\hat\mu_g, \hat\gamma_g, \hat\beta_g)^\top$:**
   - Метод: решение штрафуемой системы через QR
   - Размер: $p_g = K_g = m_g + 3$
   - $\hat\beta_g \in \mathbb{R}^{K_g-2}$ — коэффициенты сплайна

4. **Рабочий масштаб $\hat\sigma_g^2$:**
   - Формула: $\hat\sigma_g^2 = \max(0, \hat\sigma_g^{2,\text{REML}} - \bar{\tau}^2_g)$
   - $\hat\sigma_g^{2,\text{REML}} = \text{RSS}_g(\hat\lambda_g) / (n_g - \text{edf}_g(\hat\lambda_g))$
   - $\bar{\tau}^2_g = \frac{1}{n_g} \sum_{r=1}^{n_g} \tau^{2,\text{use}}_r$

5. **Степени свободы $\nu_g$:**
   - Формула: $\nu_g = n_g - \text{edf}_g(\hat\lambda_g)$
   - $\text{edf}_g(\lambda) = \|M_g(\lambda)\|_F^2$, где $(R^{\text{qr}}_g(\lambda))^\top M_g(\lambda) = W_g^\top$

6. **Калибровочный коэффициент $\kappa_g$ (только production):**
   - Метод: перебор по сетке $\mathcal{K} = \{0.50, 0.55, \dots, 3.00\}$
   - Критерий: минимизация $|\widehat{\text{cov}}_g(\kappa) - 0.90|$
   - Порог: $|\mathcal{I}_g^{\text{LOY}}| \ge 200$ (иначе $\kappa_g=1$)
   - В LOY: всегда $\kappa_g = 1$

### D. Вычисляемые параметры

**Для прогноза в точке $(c^\ast, g, j^\ast, a_{\text{new}})$:**

1. **Вектор регрессоров $c_\ast \in \mathbb{R}^{p_g}$:**
   $$
   c_\ast = (1,\ x_{\text{new}},\ b_{g,1}(x_{\text{new}}), \dots, b_{g,K_g-2}(x_{\text{new}}))^\top
   $$

2. **Точечный прогноз $\hat m_\ast$:**
   $$
   \hat m_\ast = c_\ast^\top \hat\theta_g
   $$

3. **Прогностический масштаб $s_{\text{pred}}$:**
   $$
   s_{\text{pred}}^2 = \hat\sigma_g^2 (1 + c_\ast^\top w)
   $$
   где $w$ из решения $R_g^\top u = c_\ast$, $R_g w = u$.

4. **Квантили на шкалах $Y$ и $T$ (Монте-Карло):**
   - Генерация: $Z^{(b)}_{\text{new}} = \hat m_\ast + \kappa_g s_{\text{pred}} \xi^{(b)}$, $\xi^{(b)} \sim t_{\nu_g}$
   - Добавка эталона: $Y^{(b)}_{\text{new}} = \ln \hat R^{\text{use}} + Z^{(b)}_{\text{new}} + \delta^{(b)}$, $\delta^{(b)} \sim N(0, \tau^{2,\text{use}})$
   - Квантили $Y$: type 7 по выборке $\{Y^{(b)}_{\text{new}}\}_{b=1}^{N_{\text{final}}}$
   - Квантили $T$: $\widehat{q}_p(T) = \exp(\widehat{q}_p(Y))$

### E. Методы и их результаты

| **Метод** | **Параметры** | **Результат** |
|-----------|---------------|---------------|
| MAD-винзоризация | $K_z=3$ | Очищенные $z_r^{\text{win}}$ |
| Квантильные узлы + слияние | $\{0.10, \dots, 0.90\}$, $\Delta_{\min}=1$ | $\{t_{g,i}\}_{i=0}^{m_g}$ |
| Центрированный базис (QR) | $a^o=35$, условия $h_g(0)=h'_g(0)=0$ | $C_g$, $b_{g,k}(x)$ |
| Спектральная регуляризация | $\varepsilon_\Lambda = 10^{-10} \max(1, \max \Lambda_{ii})$ | $\tilde{K}^{\beta}_g$ |
| REML-оптимизация | Границы $[10^{-8}, 10^8]$, фильтры | $\hat\lambda_g$, $\hat\theta_g$, $\hat\sigma_g^{2,\text{REML}}$, $\nu_g$ |
| Корректировка масштаба | Среднее $\bar{\tau}^2_g$ по наблюдениям | $\hat\sigma_g^2$ |
| Калибровка покрытия | Сетка $\mathcal{K}$, LOY-интервалы | $\kappa_g$ |
| Монте-Карло протокол | BLAKE2b seed, адаптивный $N$ | Квантили $\widehat{q}_p(Y)$, $\widehat{q}_p(T)$ |

### F. Ключевые инварианты и ограничения

1. **Согласованность пары $(\hat R^{\text{use}}, \tau^{2,\text{use}})$:**
   - Строятся на одном $J'$ и одном $S$
   - Нельзя смешивать режимы

2. **Центрирование сплайна:**
   - $h_g(0)=0$, $h'_g(0)=0$ в точке $a^o=35$
   - Обеспечивает идентифицируемость $(\mu_g, \gamma_g)$

3. **Независимость компонент неопределённости:**
   - Шум на $Z$: $\kappa_g s_{\text{pred}} \xi$, $\xi \sim t_{\nu_g}$
   - Ошибка эталона: $\delta \sim N(0, \tau^{2,\text{use}})$
   - Рабочее допущение: $\xi \perp \delta$

4. **Калибровка только по MC-интервалам:**
   - НЕ использовать аналитические $t$-интервалы
   - Калибровка и отчётность на одном механизме

5. **Детерминизм и воспроизводимость:**
   - Seed детерминирован от цели и режима
   - Узлы детерминированы (квантили → слияние)
   - QR-разложение детерминировано (единственное при $R_{kk}>0$)

### G. Дополнительная информация для восстановления логики

**Порядок операций (критичен):**
1. Построение эталонов $\hat R^{\text{use}}$, $\tau^{2,\text{use}}$ (по режиму)
2. Нормировка: $z_r = \ln T_r - \ln R^{\text{use}}_r$
3. MAD-винзоризация $z_r \to z_r^{\text{win}}$ (один раз, до REML)
4. Построение узлов и базиса (детерминированно)
5. REML-оценка с регуляризацией
6. Корректировка масштаба $\hat\sigma_g^2$
7. (Если production) Калибровка $\kappa_g$ на LOY-данных
8. Прогноз через MC для новой цели

**Библиотеки (Python):**
- `numpy`: линейная алгебра, QR, спектральное разложение
- `scipy.interpolate.BSpline`: B-сплайны и производные
- `scipy.optimize.minimize_scalar`: оптимизация REML
- `scipy.linalg.solve_triangular`: решение треугольных систем
- `scipy.stats.t`: распределение Стьюдента
- `hashlib.blake2b`: детерминированный seed

**Размерности (типичные для MVP):**
- $n_g \sim 1000{-}10000$ (наблюдений на пол)
- $K_g \sim 10{-}15$ (базисных функций)
- $p_g = K_g$ (параметров модели)
- $m_g \sim 7{-}12$ (узлов после слияния)
- $N_{\text{final}} \sim 50000{-}100000$ (MC-реплик)

---

